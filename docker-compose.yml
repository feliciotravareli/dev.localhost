version: "3"
services:
    traefik:
        image: traefik:v2.9
        container_name: traefik
        ports:
            - "80:80" # The HTTP port
            - "443:443" # The HTTPS port
            - "8080:8080" # The Web UI (enabled by --api.insecure=true)
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro # So that Traefik can listen to the Docker events
            - ./config/static.yml:/etc/traefik/traefik.yml:ro
            - ./config/dynamic.yml:/etc/traefik/dynamic.yml:ro
            - ./certs:/etc/certs:ro
        extra_hosts:
            - "host.docker.internal:host-gateway"
        restart: unless-stopped
        #network_mode: host # linux only
        networks: # windows only
            - proxy

    mariadb:
        image: mariadb:10.11
        container_name: mariadb
        ports:
            - 3306:3306
        command: --max_allowed_packet=1073741824 # 1GB
        volumes:
            - ./docker-data/mariadb:/var/lib/mysql
        user: ${USER_ID:-1000}:${GROUP_ID:-1000}
        environment:
            UID: ${USER_ID:-1000}
            GID: ${GROUP_ID:-1000}
            MYSQL_ROOT_PASSWORD: 'password'
            MYSQL_ROOT_HOST: '%'
            MYSQL_DATABASE: 'local'
            MYSQL_USER: 'admin'
            MYSQL_PASSWORD: 'password'
            MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
        #docker exec -i mariadb sh -c 'exec mariadb -uroot -ppassword --max-allowed-packet=1073741824 --database bd_destino' < /home/.../dump.sql
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-ppassword"]
            retries: 3
            timeout: 5s
        restart: unless-stopped
        networks:
            - proxy

networks:
  proxy:
    external: true
