version: "3"
services:
    proxy:
        image: jc21/nginx-proxy-manager:latest
        container_name: proxy-manager
        environment:
            DISABLE_IPV6: 'true'
        volumes:
            - ./docker-data/nginx-proxy-manager:/data
            - ./letsencrypt:/etc/letsencrypt
        restart: unless-stopped
        network_mode: "host"

    portainer:
        image: portainer/portainer-ce:latest
        container_name: portainer
        ports:
            - 9443:9443
        volumes:
            - ./docker-data/portainer:/data
            - /var/run/docker.sock:/var/run/docker.sock
        restart: unless-stopped

    mariadb:
        image: mariadb:10
        container_name: mariadb
        ports:
            - 3306:3306
        environment:
            MYSQL_ROOT_PASSWORD: 'password'
            MYSQL_ROOT_HOST: '%'
            MYSQL_DATABASE: 'laravel'
            MYSQL_USER: 'laravel'
            MYSQL_PASSWORD: 'password'
            MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
        volumes:
            - ./docker-data/mariadb:/var/lib/mysql
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-ppassword"]
            retries: 3
            timeout: 5s

    redis:
        image: redis:alpine
        container_name: redis
        ports:
            - 6379:6379
        healthcheck:
            test: [ "CMD", "redis-cli", "ping" ]
            retries: 3
            timeout: 5s
        volumes:
            - ./docker-data/redis:/data
        restart: on-failure

    soketi:
        image: quay.io/soketi/soketi:latest-16-alpine
        container_name: soketi
        environment:
            SOKETI_DEBUG: 1
            SOKETI_METRICS_SERVER_PORT: 9601
            DEFAULT_APP_ID: 'app-id'
            DEFAULT_APP_KEY: 'app-key'
            DEFAULT_APP_SECRET: 'app-secret'
        ports:
            - 6001:6001
            - 9601:9601
        restart: on-failure

    meilisearch:
        image: getmeili/meilisearch:latest
        container_name: meilisearch
        ports:
            - 7700:7700
        volumes:
            - ./docker-data/meilisearch:/meili_data
        healthcheck:
            test: ["CMD", "wget", "--no-verbose", "--spider",  "http://localhost:7700/health"]
            retries: 3
            timeout: 5s
        restart: on-failure

    mailpit:
        image: axllent/mailpit:latest
        container_name: mailpit
        ports:
            - 1025:1025
            - 8025:8025
        restart: on-failure

    minio:
        image: minio/minio:latest
        container_name: minio
        ports:
            - 9000:9000
            - 8900:8900
        environment:
            MINIO_ROOT_USER: 'admin'
            MINIO_ROOT_PASSWORD: 'password'
        volumes:
            - ./docker-data/minio:/data/minio
        command: minio server /data/minio --console-address ":8900"
        healthcheck:
            test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
            retries: 3
            timeout: 5s
        restart: on-failure
