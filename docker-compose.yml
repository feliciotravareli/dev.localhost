version: "3"
services:
    traefik:
        image: traefik:v2.9
        container_name: traefik
        restart: unless-stopped
        ports:
            - "80:80" # The HTTP port
            - "443:443" # The HTTPS port
            - "8080:8080" # The Web UI (enabled by --api.insecure=true)
        extra_hosts:
            - "host.docker.internal:host-gateway"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro # So that Traefik can listen to the Docker events
            - ./config/static.yml:/etc/traefik/traefik.yml:ro
            - ./config/dynamic.yml:/etc/traefik/dynamic.yml:ro
            - ./certs:/etc/certs:ro
        network_mode: host # linux only
        # networks: # windows only
        #     - proxy



    portainer:
        image: portainer/portainer-ce:latest
        container_name: portainer
        ports:
            - 9443:9443
        command: --admin-password '$$2y$$05$$GIREErZJylvl7EnNeBO8nu9FgR5aDsa4oG5kNpSGPMNkW.GG6/9TS' #password
        volumes:
            - ./docker-data/portainer:/data
            - /var/run/docker.sock:/var/run/docker.sock
        labels:
            - "traefik.enable=true"
            - "traefik.docker.network=proxy"
            - "traefik.http.routers.portainer.tls=true"
            - "traefik.http.routers.portainer.rule=Host(`portainer.docker.localhost`)"
            - "traefik.http.services.portainer.loadbalancer.server.scheme=https"
            - "traefik.http.services.portainer.loadbalancer.server.port=9443"

        restart: unless-stopped
        networks:
            - proxy

    mariadb:
        image: mariadb:10.11
        container_name: mariadb
        ports:
            - 3306:3306
        environment:
            MYSQL_ROOT_PASSWORD: 'password'
            MYSQL_ROOT_HOST: '%'
            MYSQL_DATABASE: 'laravel'
            MYSQL_USER: 'laravel'
            MYSQL_PASSWORD: 'password'
            MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
        volumes:
            - ./docker-data/mariadb:/var/lib/mysql
        command: --max_allowed_packet=1073741824 # 1GB
        #docker exec -i mariadb sh -c 'exec mariadb -uroot -ppassword --max-allowed-packet=1073741824 --database bd_destino' < /home/.../dump.sql
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-ppassword"]
            retries: 3
            timeout: 5s
        networks:
            - proxy
        restart: unless-stopped

    redis:
        image: redis:alpine
        container_name: redis
        ports:
            - 6379:6379
        volumes:
            - ./docker-data/redis:/data
        healthcheck:
            test: [ "CMD", "redis-cli", "ping" ]
            retries: 3
            timeout: 5s
        networks:
            - proxy
        restart: on-failure

    soketi:
        image: quay.io/soketi/soketi:latest-16-alpine
        container_name: soketi
        environment:
            SOKETI_DEBUG: 1
            SOKETI_METRICS_SERVER_PORT: 9601
            DEFAULT_APP_ID: 'app-id'
            DEFAULT_APP_KEY: 'app-key'
            DEFAULT_APP_SECRET: 'app-secret'
        ports:
            - 6001:6001
            - 9601:9601
        networks:
            - proxy
        restart: on-failure

    meilisearch:
        image: getmeili/meilisearch:latest
        container_name: meilisearch
        ports:
            - 7700:7700
        volumes:
            - ./docker-data/meilisearch:/meili_data
        healthcheck:
            test: ["CMD", "wget", "--no-verbose", "--spider",  "http://meilisearch.docker.localhost:7700/health"]
            retries: 3
            timeout: 5s
        networks:
            - proxy
        labels:
            - "traefik.enable=true"
            - "traefik.docker.network=proxy"
            - "traefik.http.routers.meilisearch.tls=true"
            - "traefik.http.routers.meilisearch.rule=Host(`meilisearch.docker.localhost`)"
            - "traefik.http.services.meilisearch.loadbalancer.server.port=7700"
        restart: on-failure
        depends_on:
            - traefik

    mailpit:
        image: axllent/mailpit:latest
        container_name: mailpit
        ports:
            - 1025:1025
            - 8025:8025
        labels:
            - "traefik.enable=true"
            - "traefik.docker.network=proxy"
            - "traefik.http.routers.mailpit.tls=true"
            - "traefik.http.routers.mailpit.rule=Host(`mailpit.docker.localhost`)"
            - "traefik.http.services.mailpit.loadbalancer.server.port=8025"
        networks:
            - proxy
        restart: on-failure
        depends_on:
            - traefik

    minio:
        image: minio/minio:latest
        container_name: minio
        ports:
            - 9000:9000
            - 8900:8900
        environment:
            MINIO_ROOT_USER: 'admin'
            MINIO_ROOT_PASSWORD: 'password'
        volumes:
            - ./docker-data/minio:/data/minio
        command: minio server /data/minio --console-address ":8900"
        labels:
            - "traefik.enable=true"
            - "traefik.docker.network=proxy"
            - "traefik.http.routers.minio.tls=true"
            - "traefik.http.routers.minio.rule=Host(`minio.docker.localhost`)"
            - "traefik.http.services.minio.loadbalancer.server.port=8900"
        healthcheck:
            test: [ "CMD", "curl", "-f", "http://minio.docker.localhost:9000/minio/health/live" ]
            retries: 3
            timeout: 5s
        networks:
            - proxy
        restart: on-failure
        depends_on:
            - traefik
networks:
  proxy:
    external: true
